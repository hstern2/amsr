<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AMSR demo</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://3Dmol.csb.pitt.edu/build/3Dmol-min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: Arial;
        }
        #viewer2d {
            position: relative;
            height: 396px;
            width: 396px;
            border: solid black 1px;
            padding: 1px;
        }
        #viewer3d {
            position: relative;
            height: 402px;
            width: 402px;
        }
        #amsr, #smiles {
            font-family: Courier;
            font-size: 16px;
        }
        #ener {
            resize: none
        }
    </style>
</head>
<body>
    <table>
    <tr><td>AMSR:
    </td>
    <td><input
            placeholder="enter AMSR"
            id="amsr"
            type="text"
            name="text"
            size="76"
            autocapitalize="off"
            autocorrect="off"
            autocomplete="on"
            onkeyup="mol_changed(false, true, true)" // amsr to smiles
            title="Enter an AMSR (ASCII Molecular String Representation) string to convert to SMILES and visualize"
        ></input></td>
    </tr>
    <tr><td>SMILES:</td>
    <td><input
            placeholder="enter SMILES"
            id="smiles"
            type="text"
            name="text"
            size="76"
            autocapitalize="off"
            autocorrect="off"
            autocomplete="on"
            onkeyup="mol_changed(true, true, true)" // smiles to amsr
            title="Enter a SMILES (Simplified Molecular Input Line Entry System) string to convert to AMSR and visualize"
        ></input>
    </td></tr>
    </table>

    <table>
    <tr>
    <td>
    <button
        id="generate"
        name="generate"
        onclick="generate()"
        title="Generate a new AMSR string using the LSTM model based on the seed in the AMSR field"
        >generate
    </button>
    <button
            id="invertView"
            name="invertView"
            onclick="invertView()"
            title="Flip the 2D molecule view horizontally (180° rotation around vertical axis)"
            ><i class="fas fa-camera-rotate"></i>
    </button>
    <button
            id="counterClockwise"
            name="counterClockwise"
            onclick="rotateCounterClockwise()"
            title="Rotate the 2D molecule view counter-clockwise by 30°"
            ><i class="fas fa-rotate-left"></i>
    </button>
    <button
            id="clockwise"
            name="clockwise"
            onclick="rotateClockwise()"
            title="Rotate the 2D molecule view clockwise by 30°"
            ><i class="fas fa-rotate-right"></i>
    </button>
    <input
            type="checkbox"
            id="stringent"
            name="stringent"
            checked
            onclick="mol_changed(false, true, true)"
            title="Enable stringent mode for more strict AMSR encoding/decoding"
            >stringent
    <input
            type="checkbox"
            id="threeD"
            name="threeD"
            checked
            onclick="mol_changed(true, false, true)"
            title="Show 3D molecular viewer and calculate conformer energy"
            >3D
    &nbsp; &nbsp; &nbsp;
    <a href="https://github.com/hstern2/amsr" aria-label="GitHub" title="source code on GitHub">
      <i class="fa-brands fa-github"></i>
    </a>
    </td>

    <td>
    <button
        id="newConformer"
        name="newConformer"
        onclick="mol_changed(true, false, true)"
        title="Generate a new 3D conformer with different geometry and recalculate energy"
        >new conformer</button>
    <button
        id="saveAsSDF"
        name="saveAsSDF"
        onclick="save_as_SDF()"
        title="Download the current 3D molecular structure as an SDF (Structure Data File) file"
        >save as SDF</button>
    </td></tr>

        <tr>
            <td id="viewer2d"></td>
            <td id="viewer3d"></td>
        </tr>
        <tr>
            <td id="qed"></td>
            <td id="ener"></td>
        </tr>
        <tr>
            <td id="tpsa"></td>
            <td></td>
        </tr>
        <tr>
            <td id="SA"></td>
            <td></td>
        </tr>
        <tr>
            <td id="hac"></td>
            <td></td>
        </tr>
        <tr>
            <td id="mw"></td>
            <td></td>
        </tr>
        <tr>
            <td id="clogp"></td>
            <td></td>
        </tr>
        <tr>
            <td id="hbd"></td>
            <td></td>
        </tr>
        <tr>
            <td id="hba"></td>
            <td></td>
        </tr>
        <tr>
            <td id="n_rot_bonds"></td>
            <td></td>
        </tr>
        <tr>
            <td id="passes_ro5"></td>
            <td></td>
        </tr>
    </table>

    <script>

    function element(id) {
        return document.getElementById(id);
    }

    let sdf = ""
    let viewer3d = $3Dmol.createViewer("viewer3d", {border: 'solid', backgroundColor: 'gainsboro'});
    let viewer2d = element("viewer2d");
    let pending = null;
    let rotationValue = 0;
    let flipMol = false;
    const rotationIncrement = 30; // degrees

    function refresh_viewer3d(ener) {
        viewer3d.removeAllModels();
        viewer3d.addModel(sdf, "sdf")
        viewer3d.setStyle({}, {stick: {}});
        viewer3d.zoomTo();
        viewer3d.zoom(0.9);
        viewer3d.render();
        element('ener').innerHTML = ener
    }

    function refresh_viewer2d(svg, qed, tpsa, sa, hac, mw, clogp, hbd, hba, n_rot_bonds, passes_ro5) {
        viewer2d.innerHTML = svg;
        element('qed').innerHTML = qed;
        element('tpsa').innerHTML = tpsa;
        element('SA').innerHTML = sa;
        element('hac').innerHTML = hac;
        element('mw').innerHTML = mw;
        element('clogp').innerHTML = clogp;
        element('hbd').innerHTML = hbd;
        element('hba').innerHTML = hba;
        element('n_rot_bonds').innerHTML = n_rot_bonds;
        element('passes_ro5').innerHTML = passes_ro5;
    }

    function invertView() {
        flipMol = !flipMol;
        mol_changed(false, true, false);
    }

    function rotateClockwise() {
        rotationValue -= rotationIncrement
        mol_changed(false, true, false);
    }

    function rotateCounterClockwise() {
        rotationValue += rotationIncrement
        mol_changed(false, true, false);
    }

    function save_as_SDF() {
        var blob = new Blob([sdf], { type: 'text/plain' });
        var a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'Untitled.sdf';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(a.href);
    }

    function generate() {
        if (pending)
            pending.abort();
        pending = $.post('/generate',
            { 'seed': element('amsr').value },
            function(response) {
                var data = JSON.parse(response);
                element('amsr').value = data.amsr;
                mol_changed(false, true, true); // amsr to smiles
            }
        );
    }

    function mol_changed(smiles_to_amsr, update2D, update3D) {
        if (element('threeD').checked) {
           element('viewer3d').style.display = 'block';
           element('ener').style.display = 'block';
           element('newConformer').style.display = 'inline';
           element('saveAsSDF').style.display = 'inline';
        } else {
           element('viewer3d').style.display = 'none';
           element('ener').style.display = 'none';
           element('newConformer').style.display = 'none';
           element('saveAsSDF').style.display = 'none';
        }
        if (pending)
            pending.abort();
        threeD = element('threeD').checked && update3D;
        pending = $.post('/mol_changed',
            {'inString': (smiles_to_amsr ? element('smiles') : element('amsr')).value,
            'smiles_to_amsr': smiles_to_amsr,
            'flipMol': flipMol,
            'threeD': threeD,
            'stringent': element('stringent').checked,
            'rotationValue': rotationValue},
            function(response) {
                var data = JSON.parse(response);
                (smiles_to_amsr ? element('amsr') : element('smiles')).value = data.outString
                if (update2D) {
                    refresh_viewer2d(data.svg, data.qed, data.tpsa, data.sa, data.hac, data.mw, data.clogp, data.hbd, data.hba, data.n_rot_bonds, data.passes_ro5);
                }
                if (threeD) {
                    sdf = data.sdf
                    refresh_viewer3d(data.ener);
                }
            }
        );
    }

    </script>
</body>
</html>
